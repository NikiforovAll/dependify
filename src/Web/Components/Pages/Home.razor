@page "/"
@using Dependify.Core
@using Dependify.Core.Graph
@using Dependify.Core.Serializers
@using Microsoft.Extensions.Options
@using static Dependify.Core.SolutionRegistry

@inject SolutionRegistry SolutionRegistry
@inject ISnackbar Snackbar
@inject IOptions<MsBuildConfig> MsBuildConfig
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>Dependify</PageTitle>

<MudToolBar>
    <MudText Typo="Typo.h4">Workbench ⚙️</MudText>
    <MudTooltip Text="Re-sync Solutions">
        <MudIconButton Icon="@Icons.Material.Filled.Sync" Size="Size.Medium" Color="Color.Primary" OnClick="() => LoadSolutionsAsync(true)" />
    </MudTooltip>
    <MudSpacer />
    <MudIconButton Icon="@Icons.Material.Outlined.PlayCircleFilled" Size="Size.Large" Color="Color.Primary" OnClick="@AnalyzeSolution" />
    <MudSelect T="string" AnchorOrigin="Origin.BottomCenter" AdornmentIcon="@Icons.Material.Filled.RocketLaunch"
        AdornmentColor="Color.Primary" @bind-Value="selectedSolution" Typo="Typo.h6" Label="Solution">
        <MudSelectItem T="string" />
        @foreach (var solutionNode in solutionNodes)
        {
            <MudSelectItem Value="@solutionNode.Id" />
        }
    </MudSelect>
</MudToolBar>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudPaper Class="pa-4 ma-16" Elevation="3">
        @if (displayMode == DisplayMode.All)
        {
            <MudSimpleTable Style="overflow-x: auto;" Dense="true" Hover="true" Bordered="true" Striped="true">
                <thead>
                    <tr>
                        <th><MudText Typo="Typo.h6">Name</MudText></th>
                        <th><MudText Typo="Typo.h6">Path</MudText></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var node in nodes)
                    {
                        <tr>
                            <td>
                            @if (node.Node.Type == NodeConstants.Solution)
                            {
                                <MudText Color="Color.Secondary">@node.Node.Id</MudText>
                            }
                            else
                            {
                                <MudText Style="@($"color:{Colors.Teal.Lighten1}")">@node.Node.Id</MudText>
                            }
                            </td>
                            <td>
                                <MudText Style="@(node.Loaded ? $"color:{Colors.Green.Darken3}": string.Empty)">
                                    @node.Node.DirectoryPath.RemovePrefix(commonPrefix)
                                    @if(node.Loaded)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                    }
                                </MudText>

                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
        else
        {
            <MudSimpleTable Style="overflow-x: auto;" Dense="true" Hover="true" Bordered="true" Striped="true">
                <thead>
                    <tr>
                        <th><MudText Style="@($"font-weight:bold")">Name</MudText></th>
                        <th><MudText Style="@($"text-align: center; font-weight:bold")">Depends On Projects</MudText></th>
                        <th><MudText Style="@($"text-align: center; font-weight:bold")">Used By Projects</MudText></th>
                        <th><MudText Style="@($"text-align: center; font-weight:bold")">Depends On Packages</MudText></th>
                        <th><MudText Style="@($"text-align: center; font-weight:bold")">Actions</MudText></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var nodeUsage in nodeUsageStatistics)
                    {
                        <tr>

                            <td>
                                <MudTooltip>
                                    <ChildContent>
                                        @if (nodeUsage.Node.Type == NodeConstants.Solution)
                                        {
                                            <MudText Color="Color.Secondary">@nodeUsage.Node.Id</MudText>
                                        }
                                        else
                                        {
                                            <MudText Style="@($"color:{Colors.Teal.Lighten1}")">@nodeUsage.Node.Id</MudText>
                                        }
                                    </ChildContent>
                                    <TooltipContent>
                                        <MudText>@nodeUsage.Node.DirectoryPath</MudText>
                                    </TooltipContent>
                                </MudTooltip>
                            </td>
                            <td style="text-align: center;">
                                <MudTooltip>
                                    <ChildContent>
                                        <MudText Style="@($"color:{Colors.Teal.Lighten3}; font-weight:bold")">@nodeUsage.DependsOnProjectsCount</MudText>
                                    </ChildContent>
                                    <TooltipContent>
                                        @foreach (var childProject in nodeUsage.DependsOnProjects)
                                        {
                                            <MudText Style="@($"color:{Colors.Teal.Lighten3}")">@childProject.Id</MudText>
                                        }
                                    </TooltipContent>
                                </MudTooltip>
                            </td>
                            <td style="text-align: center;">
                                <MudTooltip>
                                    <ChildContent>
                                        <MudText Style="@($"color:{Colors.Teal.Lighten3}; font-weight:bold")">@nodeUsage.UsedByCount</MudText>
                                    </ChildContent>
                                    <TooltipContent>
                                        @foreach (var childProject in nodeUsage.UsedBy)
                                        {
                                            <MudText Style="@($"color:{Colors.Teal.Lighten3}")">@childProject.Id</MudText>
                                        }
                                    </TooltipContent>
                                </MudTooltip>
                            </td>
                            <td style="text-align: center;">

                                <MudTooltip>
                                    <ChildContent>
                                        <MudText Style="@($"color:{Colors.Lime.Darken3}; font-weight:bold")">@nodeUsage.DependsOnPackagesCount</MudText>
                                    </ChildContent>
                                    <TooltipContent>
                                        @foreach (var package in nodeUsage.DependsOnPackages)
                                        {
                                            <MudText Style="@($"color:{Colors.Lime.Darken3}")">@package.Id [@package.Version]</MudText>
                                        }
                                    </TooltipContent>
                                </MudTooltip>

                            </td>
                            <td style="@($"text-align: center")">
                                <MudTooltip Text="Open Graph Diagram">
                                    <MudIconButton
                                        Icon="@Icons.Material.TwoTone.FileOpen"
                                        Size="Size.Medium"
                                        Color="Color.Primary"
                                        OnClick="() => ShowDiagramModal(nodeUsage.Node.Id, DiagramStyle.Graph)"/>
                                </MudTooltip>

                                <MudTooltip Text="Open C4 Diagram">
                                    <MudIconButton
                                        Icon="@Icons.Material.Filled.FileOpen"
                                        Size="Size.Medium"
                                        Color="Color.Primary"
                                        OnClick="() => ShowDiagramModal(nodeUsage.Node.Id, DiagramStyle.C4)" />
                                </MudTooltip>

                                <MudTooltip Text="Copy JSON to Clipboard">
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Medium" Color="Color.Primary" OnClick="() => CopyDiagramToClipboard(nodeUsage.Node.Id)" />
                                </MudTooltip>

                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private double ProgressValue = 0;

    private enum DiagramStyle { Graph, C4 }

    private List<NodeWithProgress> nodes = [];

    private class NodeWithProgress(Node node, bool loaded)
    {
        public Node Node { get; set; } = node;
        public bool Loaded { get;set; } = loaded;
    }

    private List<SolutionReferenceNode> solutionNodes = [];

    private string? selectedSolution;

    private List<NodeUsage> nodeUsageStatistics = [];

    private string? commonPrefix;

    private DisplayMode displayMode = DisplayMode.All;

    protected override async Task OnInitializedAsync()
    {
        SolutionRegistry.OnLoadingEvents.Subscribe(node => {
            switch(node.EventType)
            {
                case NodeEventType.SolutionLoading:
                    Snackbar.Add($"Loading - {node.Id}", Severity.Normal);
                break;
                case NodeEventType.SolutionLoaded:
                    Snackbar.Add($"Loaded - {node.Id}", Severity.Success);
                    break;
                case NodeEventType.ProjectLoaded:
                    @* Snackbar.Add($"Loaded - {node.Id}", Severity.Success); *@
                break;
                case NodeEventType.RegistryLoaded:
                    Snackbar.Add(node.Message, Severity.Success);
                    break;
            }
        });

        SolutionRegistry.OnLoadingEvents.Subscribe(node => {
            switch(node.EventType)
            {
                case NodeEventType.SolutionLoaded:
                case NodeEventType.ProjectLoaded:
                    var project = nodes.FirstOrDefault(n => n.Node.Id == node.Id);

                    if(project is not null)
                    {
                        project.Loaded = true;
                        InvokeAsync(StateHasChanged);
                    }
                    break;
            }
        });

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;

        LoadSolutions();

        selectedSolution = SolutionRegistry.Solutions.FirstOrDefault()?.Id;
    }

    private async Task LoadSolutionsAsync(bool force = false)
    {
        if(force)
        {
            nodes = SolutionRegistry.Nodes.Select(n => new NodeWithProgress(n, false)).ToList();

            Snackbar.Add($"Re-syncing solutions", Severity.Warning);

            Task.Run(async () => {
                await SolutionRegistry.LoadSolutionsAsync(MsBuildConfig.Value);
                LoadSolutions();
            });
        }
    }

    private void LoadSolutions()
    {
        nodes = SolutionRegistry.Nodes.Select(n => new NodeWithProgress(n, SolutionRegistry.IsLoaded)).ToList();

        commonPrefix = Utils.CalculateCommonPrefix(nodes.Select(n => n.Node));

        solutionNodes = SolutionRegistry.Solutions.ToList();
    }

    private void AnalyzeSolution()
    {
        var solution = solutionNodes.FirstOrDefault(n => n.Id == selectedSolution);

        if(solution is null)
        {
            @* Snackbar.Add($"Select the solution to analyze", Severity.Error); *@
            displayMode = DisplayMode.All;
        }
        else if(SolutionRegistry.GetGraph(solution) is var graph && graph is not null)
        {
            var projectUsageStatistics = graph
                .Nodes
                .OfType<ProjectReferenceNode>()
                .Select(n => SolutionRegistry.GetDependencyCount(solution, n));

            nodeUsageStatistics = new List<NodeUsage>
            {
                SolutionRegistry.GetDependencyCount(solution, solution)
            };

            nodeUsageStatistics.AddRange(projectUsageStatistics);

            displayMode = DisplayMode.Solutions;
        }
        else
        {
            Snackbar.Add($"Analyzing - {selectedSolution}, please wait...", Severity.Normal);
        }
    }

    private async Task ShowDiagramModal(string nodeId, DiagramStyle style)
    {
        var solution = solutionNodes.FirstOrDefault(n => n.Id == selectedSolution);

        var subGraph = GetSubGraph(nodeId, style == DiagramStyle.C4
            ? _ => true
            : n => n.Type is not NodeConstants.Package);

        if(subGraph is null)
        {
            return;
        }

        var diagramContent = style == DiagramStyle.C4
            ? MermaidC4Serializer.ToString(subGraph)
            : MermaidSerializer.ToString(subGraph);

        var parameters = new DialogParameters { ["DiagramContent"] = diagramContent };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraExtraLarge,
            FullWidth = true,
            FullScreen = false,
            CloseOnEscapeKey = true,
        };

        var dialog = DialogService.Show<DiagramModal>(subGraph.Root.Id, parameters, options);

        await dialog.Result;
    }

    private async Task CopyDiagramToClipboard(string nodeId)
    {
        var solution = solutionNodes.FirstOrDefault(n => n.Id == selectedSolution);

        var subGraph = GetSubGraph(nodeId, _ => true);

        if(subGraph is null)
        {
            return;
        }

        Snackbar.Add($"Copied to clipboard", Severity.Normal);

        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", JsonGraphSerializer.ToString(subGraph));
    }

    private DependencyGraph? GetSubGraph(string nodeId, Predicate<Node>? filter = default)
    {
        var solution = solutionNodes.FirstOrDefault(n => n.Id == selectedSolution);

        if(SolutionRegistry.GetGraph(solution) is var graph && graph is not null)
        {
            var project = graph.Nodes.FirstOrDefault(n => n.Id == nodeId);

            displayMode = DisplayMode.Solutions;

            var subGraph = graph.SubGraph(project, filter);

            return subGraph;
        }

        return default;
    }

    private enum DisplayMode
    {
        All,
        Solutions,
    }
}
